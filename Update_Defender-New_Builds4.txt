# Create 'defenderUpdate1' (root) 09:00 & 17:00 — inline command (WSUS first, fallback to MicrosoftUpdate), no immediate run
Import-Module ScheduledTasks -ErrorAction Stop

# Action: inline PowerShell command (no external file)
$inline = 'try { Update-MpSignature } catch { Update-MpSignature -UpdateSource MicrosoftUpdate }'
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NoLogo -NoProfile -ExecutionPolicy Bypass -Command \"$inline\""

# Triggers
$trigger1 = New-ScheduledTaskTrigger -Daily -At 09:00
$trigger2 = New-ScheduledTaskTrigger -Daily -At 17:00

# Run as SYSTEM, highest
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest

# Settings (StartWhenAvailable NÃO executa agora; só se um horário foi perdido)
$settings = New-ScheduledTaskSettingsSet -StartWhenAvailable -AllowStartIfOnBatteries -ExecutionTimeLimit (New-TimeSpan -Hours 1)

# Create/replace in root
$taskName = "defenderUpdate1"
if (Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue) {
  Unregister-ScheduledTask -TaskName $taskName -Confirm:$false
}
Register-ScheduledTask -TaskName $taskName -Action $action -Trigger @($trigger1, $trigger2) -Principal $principal -Settings $settings
