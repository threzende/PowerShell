$script = @'
$ErrorActionPreference = "Stop"
Update-MpSignature
'@

$folder = "$env:ProgramData\DefenderUpdate"
New-Item -ItemType Directory -Path $folder -Force | Out-Null
$ps1 = Join-Path $folder "DefenderUpdate1.ps1"
$script | Out-File -FilePath $ps1 -Encoding UTF8 -Force

$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NoLogo -NoProfile -ExecutionPolicy Bypass -File `"$ps1`""
$trigger1 = New-ScheduledTaskTrigger -Daily -At 09:00
$trigger2 = New-ScheduledTaskTrigger -Daily -At 17:00
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
$settings = New-ScheduledTaskSettingsSet -StartWhenAvailable -AllowStartIfOnBatteries -ExecutionTimeLimit (New-TimeSpan -Hours 1)

$taskName = "defenderUpdate1"
$description = "Updates Microsoft Defender signature definitions at 09:00 and 17:00."

if (Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue) {
  Unregister-ScheduledTask -TaskName $taskName -Confirm:$false
}

Register-ScheduledTask -TaskName $taskName -Action $action -Trigger @($trigger1, $trigger2) -Principal $principal -Settings $settings -Description $description
