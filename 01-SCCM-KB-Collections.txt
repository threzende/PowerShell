1 ######################################

# ============================
# SCCM CLIENT SNAPSHOT v2 (read-only)
# ============================

$OutDir  = 'C:\temp\sccm'
$OutFile = Join-Path $OutDir 'client-sccm-snapshot.txt'
$Width   = 200

if (-not (Test-Path $OutDir)) {
    New-Item -ItemType Directory -Path $OutDir -Force | Out-Null
}

function Write-Line {
    param([string]$Text = "")
    $Text | Out-File -FilePath $OutFile -Append -Encoding UTF8 -Width $Width
}

function Get-LastLines {
    param([string]$Path, [int]$Lines = 200)
    if (Test-Path $Path) {
        Get-Content -Path $Path -Tail $Lines -ErrorAction SilentlyContinue
    } else {
        "**LOG não encontrado: $Path**"
    }
}

$logDir = Join-Path $env:WINDIR 'CCM\Logs'
$logs = @{
    PolicyAgent     = Join-Path $logDir 'PolicyAgent.log'
    PolicyEvaluator = Join-Path $logDir 'PolicyEvaluator.log'
    AppDiscovery    = Join-Path $logDir 'AppDiscovery.log'
    AppEnforce      = Join-Path $logDir 'AppEnforce.log'
    ExecMgr         = Join-Path $logDir 'ExecMgr.log'
}

"===== SCCM CLIENT SNAPSHOT =====" | Out-File $OutFile -Encoding UTF8
Write-Line "Máquina : $env:COMPUTERNAME"
Write-Line "Data    : $(Get-Date)"
Write-Line ""

# 1) Collections do CLIENTE (se a classe existir)
Write-Line "--- Collections (WMI: root\ccm\policy\machine\actualconfig) ---"
$ns = 'root\ccm\policy\machine\actualconfig'
$colClassExists = $false
try {
    $c = Get-CimClass -Namespace $ns -ClassName 'CCM_CollectionMembership' -ErrorAction Stop
    if ($c) { $colClassExists = $true }
} catch {}

if ($colClassExists) {
    $cols = Get-CimInstance -Namespace $ns -ClassName 'CCM_CollectionMembership' | Sort-Object CollectionID
    foreach ($c in $cols) {
        # compacta múltiplos espaços
        $line = ("{0}  {1}" -f $c.CollectionID, $c.CollectionName) -replace '\s{2,}',' '
        Write-Line $line
    }
} else {
    Write-Line "(classe CCM_CollectionMembership não existe no cliente neste momento)"
}
Write-Line ""

# 2) PolicyAgent.log – mostrar só linhas de policy, enxutas
Write-Line "--- PolicyAgent.log (políticas recebidas) ---"
Get-LastLines -Path $logs.PolicyAgent -Lines 300 |
    Where-Object { $_ -match 'policy' } |
    ForEach-Object {
        # tira espaços exagerados
        ($_ -replace '\s{2,}', ' ')
    } | Select-Object -Last 80 |
    ForEach-Object { Write-Line $_ }
Write-Line ""

# 3) PolicyEvaluator.log – extrair só GUIDs de policy
Write-Line "--- PolicyEvaluator.log (avaliação de policy) ---"
$pols = Get-LastLines -Path $logs.PolicyEvaluator -Lines 300 |
    Where-Object { $_ -match 'Applying policy' }

if ($pols) {
    $clean = @()
    foreach ($p in $pols) {
        if ($p -match '\{[0-9A-Fa-f-]+\}') {
            $clean += $matches[0]
        }
    }
    $clean | Select-Object -Unique | ForEach-Object { Write-Line $_ }
} else {
    Write-Line "(nenhuma linha de Applying policy encontrada)"
}
Write-Line ""

# 4) AppEnforce.log – o que instalou
Write-Line "--- AppEnforce.log (instalação de app) ---"
Get-LastLines -Path $logs.AppEnforce -Lines 200 |
    Where-Object { $_ -match 'Starting install|Successfully|Failed|Prepared command line' } |
    ForEach-Object { ($_ -replace '\s{2,}',' ') } |
    ForEach-Object { Write-Line $_ }
Write-Line ""

# 5) ExecMgr.log – pacotes/TS
Write-Line "--- ExecMgr.log (pacotes/programas/TS) ---"
Get-LastLines -Path $logs.ExecMgr -Lines 200 |
    Where-Object { $_ -match 'executing|program started|Raised program completion|Install completion' } |
    ForEach-Object { ($_ -replace '\s{2,}',' ') } |
    ForEach-Object { Write-Line $_ }
Write-Line ""

Write-Line "===== FIM ====="
Write-Host "Pronto. Gerado em: $OutFile"




2 #############################
# ===== SCCM SNAPSHOT v3 (super seco) =====
$base = 'C:\temp\sccm'
if (-not (Test-Path $base)) {
    New-Item -Path $base -ItemType Directory -Force | Out-Null
}

$logDir = Join-Path $env:WINDIR 'CCM\Logs'
$polFile  = Join-Path $base 'policies.txt'
$appsFile = Join-Path $base 'apps.txt'

# 1) POLICIES (pega só os GUIDs únicos)
$polLines = Get-Content (Join-Path $logDir 'PolicyEvaluator.log') -Tail 600 -ErrorAction SilentlyContinue
$guids = @()
foreach ($l in $polLines) {
    if ($l -match '\{[0-9A-Fa-f-]+\}') {
        $guids += $matches[0]
    }
}
$guids | Sort-Object -Unique | Set-Content -Path $polFile -Encoding UTF8

# 2) APPS (descoberta + instalação)
$appDisc  = Get-Content (Join-Path $logDir 'AppDiscovery.log') -Tail 200 -ErrorAction SilentlyContinue |
            Select-String -Pattern 'Carbon Black|Performing detection of app deployment type|application' -SimpleMatch
$appEnf   = Get-Content (Join-Path $logDir 'AppEnforce.log') -Tail 200 -ErrorAction SilentlyContinue |
            Select-String -Pattern 'Starting install enforcement for App DT|Prepared command line' -SimpleMatch

"--- AppDiscovery ---" | Set-Content -Path $appsFile -Encoding UTF8
$appDisc | ForEach-Object { $_.Line -replace '\s{2,}',' ' } | Add-Content -Path $appsFile
"--- AppEnforce ---"  | Add-Content -Path $appsFile
$appEnf  | ForEach-Object { $_.Line -replace '\s{2,}',' ' } | Add-Content -Path $appsFile

Write-Host "Gerado:"
Write-Host " - $polFile"
Write-Host " - $appsFile"



3 ##########################


and SMS_R_System.Name <> "CLDCP0004T"

