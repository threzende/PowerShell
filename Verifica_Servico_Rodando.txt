@echo off
setlocal enabledelayedexpansion

REM Caminho para o arquivo com a lista de servidores
set "servidoresPath=C:\temp\nwsq\servidores.txt"

REM Nome do serviço a ser verificado
set "nomeServico=xagt"

REM Verificar se o arquivo existe
if not exist "%servidoresPath%" (
    echo Arquivo de servidores nao encontrado em %servidoresPath%
    exit /b 1
)

REM Inicializar o contador
set /a contador=0

REM Ler a lista de servidores e verificar o status do serviço
for /f "tokens=*" %%s in (%servidoresPath%) do (
    REM Incrementar o contador
    set /a contador+=1

    REM Exibir o número do servidor
    echo Verificando servidor !contador!: %%s

    REM Verificar se o servidor está acessível
    ping -n 1 %%s >nul 2>&1
    if errorlevel 1 (
        echo !contador!: %%s: Nao foi possivel conectar ao servidor
    ) else (
        REM Obter status do serviço e salvar em um arquivo temporário
        sc \\%%s query %nomeServico% > "%temp%\sc_query_!contador!.txt"

        REM Verificar se o serviço está rodando
        findstr /i "STATE" "%temp%\sc_query_!contador!.txt" | findstr /i "RUNNING" >nul
        if errorlevel 0 (
            echo !contador!: %%s: %nomeServico% esta Running
        ) else (
            echo !contador!: %%s: %nomeServico% NAO esta Running
        )

        REM Limpar o arquivo temporário
        del "%temp%\sc_query_!contador!.txt"
    )
)

REM Pausa para manter a janela aberta
pause

endlocal
