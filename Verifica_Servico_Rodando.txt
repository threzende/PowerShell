# Caminho para o arquivo com a lista de servidores
$servidoresPath = "C:\temp\nwsq\servidores.txt"

# Nome do serviço a ser verificado
$nomeServico = "xagt"

# Verificar se o arquivo existe
if (-Not (Test-Path -Path $servidoresPath)) {
    Write-Host ("Arquivo de servidores não encontrado em " + $servidoresPath) -ForegroundColor Red
    exit
}

# Ler a lista de servidores
$servidores = Get-Content -Path $servidoresPath

# Inicializar o contador
$contador = 0

# Loop para verificar o status do serviço em cada servidor
foreach ($servidor in $servidores) {
    # Incrementar o contador
    $contador++

    # Exibir o número do servidor
    Write-Host ("Verificando servidor " + $contador + ": " + $servidor)

    # Testar conexão com o servidor
    if (Test-Connection -ComputerName $servidor -Count 1 -Quiet) {
        try {
            # Obter status do serviço
            $statusServico = Get-Service -Name $nomeServico -ComputerName $servidor -ErrorAction Stop

            if ($statusServico.Status -eq 'Running') {
                Write-Host ($contador + ": " + $servidor + ": " + $nomeServico + " está Running") -ForegroundColor Green
            } else {
                Write-Host ($contador + ": " + $servidor + ": " + $nomeServico + " NÃO está Running (Status: " + $statusServico.Status + ")") -ForegroundColor Yellow
            }
        } catch {
            # Captura erros e exibe mensagem apropriada
            Write-Host ($contador + ": " + $servidor + ": Erro ao tentar verificar o serviço (" + $_.Exception.Message + ")") -ForegroundColor Red
        }
    } else {
        Write-Host ($contador + ": " + $servidor + ": Não foi possível conectar ao servidor") -ForegroundColor Red
    }
}

# Pausa para manter a janela aberta
Read-Host -Prompt "Pressione Enter para sair"
